services:
  db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: ratewise
      POSTGRES_PASSWORD: Anonymous263
      POSTGRES_DB: ratewise
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ratewise"]
      interval: 5s
      timeout: 5s
      retries: 5

  app:
    image: mpratamamail/ratewise:latest
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      # NOTE: password here MUST match POSTGRES_PASSWORD above
      DATABASE_URL: postgresql://ratewise:Anonymous263@db:5432/ratewise
      # Locally reads NEXTAUTH_URL from .env (http://localhost:3000);
      # on Phala Cloud (no .env) defaults to https://ratewise.es
      NEXTAUTH_URL: ${NEXTAUTH_URL:-https://ratewise.es}
      NEXTAUTH_SECRET: VeUOkA9VVajh2tSQXEey0ezXDQhj1xMLnLpgCHcR2iWU8s+p0YrGwtq9u34=
      NEXT_PUBLIC_SITE_URL: https://ratewise.es
      ADMIN_EMAIL: admin@ratewise.es
      ADMIN_PASSWORD: Anonymous263
      CONTACT_EMAIL: hello@ratewise.es
    depends_on:
      db:
        condition: service_healthy

  # Phala Cloud Custom Domain + Auto SSL (Cloudflare DNS + Let's Encrypt)
  dstack-ingress:
    image: dstacktee/dstack-ingress:20250924@sha256:40429d78060ef3066b5f93676bf3ba7c2e9ac47d4648440febfdda558aed4b32
    restart: unless-stopped
    ports:
      - "443:443"
    environment:
      - DOMAIN=ratewise.es
      - TARGET_ENDPOINT=http://app:3000
      - CLOUDFLARE_API_TOKEN=4qiY8NX07V5VNbCfErdbhm01BKo9BAM3GEp13ibo
      - GATEWAY_DOMAIN=_.${DSTACK_GATEWAY_DOMAIN}
      - CERTBOT_EMAIL=mpratama.yt@gmail.com
      - SET_CAA=true
    volumes:
      - /var/run/dstack.sock:/var/run/dstack.sock
      - cert-data:/etc/letsencrypt
    depends_on:
      - app

volumes:
  pgdata:
  cert-data:
